# Prompt Enhancement v1.4 - 用户故事和任务

> **版本**: 1.0
> **日期**: 2025-12-24
> **状态**: 就绪待执行

---

## 📚 故事映射

### Epic 1: Meta Prompt Engine - 从描述生成结构化Prompt

**目标**: 让用户能从自然语言任务描述自动生成高质量的XML结构化prompt

**优先级**: 🔴 **关键**
**预期工作量**: 2天
**价值**: 核心功能，其他功能的基础

---

#### Story 1.1: 实现变量识别引擎

```markdown
# Story: 实现变量识别引擎

## 描述
实现MetaPromptEngine的第一个核心方法，能够从任务描述中识别需要的输入变量。

## 验收标准
- [ ] 能识别 CODE, DATA, CONTEXT等常见变量类型
- [ ] 识别准确率 >90%
- [ ] 支持复合变量识别 (如 CODE + LANGUAGE)
- [ ] 返回变量列表和类型提示

## 技术细节
```python
# src/prompt_enhancement/meta/prompt_engine.py
class MetaPromptEngine:
    def extract_variables(self, task_description: str) -> List[Variable]:
        """
        识别任务描述中需要的变量

        参数:
            task_description: 用户输入的自然语言任务

        返回:
            变量列表，每个包含名称、类型、是否必需
        """
```

## 关键实现
- 使用LLM分析任务描述
- 构建变量识别的meta prompt
- 解析LLM响应提取变量信息
- 缓存常见任务的变量集合

## 依赖
- LLMProvider (现有)
- PromptBuilder (现有)

## 测试用例
1. 简单代码任务: "帮我写代码审查工具"
2. 复合任务: "生成数据处理和清洗提示词"
3. 领域特定: "写SQL优化提示词"

## 完成标志
✅ extract_variables() 实现完成
✅ 单元测试通过
✅ 3个不同类型的任务验证
```

**任务分解**:
- [ ] Task 1.1.1: 设计变量识别的meta prompt (2h)
- [ ] Task 1.1.2: 实现变量提取逻辑 (3h)
- [ ] Task 1.1.3: 编写单元测试 (2h)
- [ ] Task 1.1.4: 集成缓存机制 (2h)

---

#### Story 1.2: 实现结构规划引擎

```markdown
# Story: 实现结构规划引擎

## 描述
实现MetaPromptEngine的第二个核心方法，能够根据任务类型规划合适的XML结构。

## 验收标准
- [ ] 支持5种基础结构类型 (role, context, instructions, examples, output_format)
- [ ] 根据任务类型自动调整结构
- [ ] 生成的结构schema有效
- [ ] 支持可选区块 (如 scratchpad, constraints)

## 技术细节
```python
class MetaPromptEngine:
    def plan_structure(self, task_description: str, variables: List[Variable]) -> Structure:
        """
        规划prompt的XML结构

        返回:
            Structure对象，包含所有需要的XML区块和它们的内容要求
        """
```

## 实现策略
- 分析任务类型
- 选择合适的XML结构模板
- 根据变量调整结构
- 添加可选的优化区块

## 测试用例
1. 代码审查任务 (需要代码块、问题列表)
2. 创意写作任务 (需要示例、风格指南)
3. 数据处理任务 (需要数据格式说明)
```

**任务分解**:
- [ ] Task 1.2.1: 定义结构类型和规则 (2h)
- [ ] Task 1.2.2: 实现规划逻辑 (3h)
- [ ] Task 1.2.3: 编写测试 (2h)

---

#### Story 1.3: 实现XML生成引擎

```markdown
# Story: 实现XML生成引擎

## 描述
实现MetaPromptEngine的第三个核心方法，生成最终的XML结构化prompt。

## 验收标准
- [ ] 生成的XML格式规范
- [ ] 所有变量正确替换
- [ ] 包含有意义的示例
- [ ] XML可直接使用或轻微调整

## 技术细节
```python
class MetaPromptEngine:
    def write_instructions(self, structure: Structure, variables: List[Variable]) -> str:
        """
        生成完整的XML prompt

        返回:
            格式化的XML字符串
        """
```

## 实现策略
- 调用LLM生成每个XML区块的内容
- 组装所有区块
- 变量注入 (使用{{VARIABLE}} 格式)
- 格式化和验证XML
```

**任务分解**:
- [ ] Task 1.3.1: 实现XML builder (3h)
- [ ] Task 1.3.2: 实现LLM调用编排 (3h)
- [ ] Task 1.3.3: 变量替换和验证 (2h)
- [ ] Task 1.3.4: 完整流程测试 (2h)

---

### Epic 2: Template Library - 20+场景化模板库

**目标**: 构建20+高质量的场景化Prompt模板

**优先级**: 🔴 **关键**
**预期工作量**: 2-3天
**价值**: 加速用户上手，提供最佳实践参考

---

#### Story 2.1: 定义和实现模板系统

```markdown
# Story: 定义和实现模板系统

## 描述
设计模板的YAML格式和实现模板加载、解析、渲染系统。

## 验收标准
- [ ] 模板YAML schema完整
- [ ] 模板加载器实现完成
- [ ] 模板匹配器准确率 >90%
- [ ] Jinja2变量渲染正常

## 模板YAML格式
```yaml
metadata:
  name: "Code Reviewer"
  category: "coding"
  description: "专业代码审查提示词"
  keywords: ["review", "code", "quality"]

variables:
  - name: "CODE"
    type: "code"
    required: true
    description: "要审查的代码"

template: |
  <role>
  你是一名资深的{{LANGUAGE}}代码审查专家...
  </role>
  ...

examples:
  - input:
      CODE: |
        def calc(x):
          return x*2
      LANGUAGE: "python"
    ideal_output: |
      ## 审查意见
      ...
```
```

**任务分解**:
- [ ] Task 2.1.1: 定义YAML schema (2h)
- [ ] Task 2.1.2: 实现TemplateLoader (2h)
- [ ] Task 2.1.3: 实现TemplateMatcher (3h)
- [ ] Task 2.1.4: 编写系统测试 (2h)

---

#### Story 2.2: 创建Coding模板库

```markdown
# Story: 创建Coding模板库 (5个)

## 需要创建的模板
1. bug_buster.yaml - Python Bug修复
2. code_reviewer.yaml - 代码审查
3. refactor_guide.yaml - 重构指南
4. test_generator.yaml - 测试生成
5. sql_sorcerer.yaml - SQL查询优化

## 验收标准
- [ ] 每个模板有完整的元数据
- [ ] 每个模板有2个以上的示例
- [ ] 示例代码能正确运行或呈现
- [ ] 模板能被正确加载和渲染
```

**任务分解**:
- [ ] Task 2.2.1: 创建bug_buster.yaml (1h)
- [ ] Task 2.2.2: 创建code_reviewer.yaml (1h)
- [ ] Task 2.2.3: 创建refactor_guide.yaml (1h)
- [ ] Task 2.2.4: 创建test_generator.yaml (1h)
- [ ] Task 2.2.5: 创建sql_sorcerer.yaml (1h)

---

#### Story 2.3: 创建Data & Writing模板库

```markdown
# Story: 创建Data & Writing模板库 (8个)

## Data模板 (4个)
1. csv_converter.yaml
2. excel_formula.yaml
3. data_organizer.yaml
4. json_transformer.yaml

## Writing模板 (4个)
1. prose_polisher.yaml
2. technical_doc.yaml
3. api_doc.yaml
4. readme_generator.yaml
```

**任务分解**: 每个模板1小时

---

#### Story 2.4: 创建Analysis & Meta模板库

```markdown
# Story: 创建Analysis & Meta模板库 (7个)

## Analysis模板 (4个)
1. code_audit.yaml
2. security_review.yaml
3. performance_analysis.yaml
4. dependency_check.yaml

## Meta模板 (3个)
1. prompt_generator.yaml
2. prompt_improver.yaml
3. chain_of_thought.yaml
```

**任务分解**: 每个模板1小时

---

### Epic 3: Prompt Improver - 自动优化引擎

**目标**: 实现5个优化策略自动改进现有Prompt

**优先级**: 🟡 **高**
**预期工作量**: 2-3天
**价值**: 帮助用户快速改进低质量prompt

---

#### Story 3.1: Chain-of-Thought 注入

```markdown
# Story: 实现Chain-of-Thought注入策略

## 描述
自动为prompt添加 <scratchpad> 或 <thinking> 思考区块。

## 验收标准
- [ ] 检测prompt是否已有scratchpad
- [ ] 自动生成合适的思考指导
- [ ] 保留原有prompt逻辑

## 示例
```
原始: <instructions>分析这段代码</instructions>

优化后:
<scratchpad>
首先，我需要理解代码的目的...
然后，我将检查逻辑正确性...
最后，我将提出改进建议...
</scratchpad>

<instructions>分析这段代码</instructions>
```
```

**任务分解**:
- [ ] Task 3.1.1: 实现CoTInjection类 (2h)
- [ ] Task 3.1.2: 编写策略逻辑 (2h)
- [ ] Task 3.1.3: 单元测试 (1h)

---

#### Story 3.2: 示例标准化和丰富化

```markdown
# Story: 实现示例标准化和丰富化

## 描述
- 将示例转为一致的 <example><input>..<output></example> 格式
- 为每个示例添加推理过程

## 验收标准
- [ ] 所有示例转为XML格式
- [ ] 每个示例有输入、理想输出、推理过程
- [ ] 保留原有示例意义
```

**任务分解**:
- [ ] Task 3.2.1: ExampleStandardization实现 (2h)
- [ ] Task 3.2.2: ExampleEnrichment实现 (2h)
- [ ] Task 3.2.3: 测试 (1h)

---

#### Story 3.3: 指令清晰化和变量标记

```markdown
# Story: 实现指令清晰化和变量标记

## 描述
- 重写模糊的指令，使其更清晰
- 用XML包裹长变量，明确边界

## 验收标准
- [ ] 识别模糊指令
- [ ] 自动改进指令清晰度
- [ ] 长变量用XML包裹
```

**任务分解**:
- [ ] Task 3.3.1: InstructionClarity实现 (2h)
- [ ] Task 3.3.2: VariableTagging实现 (2h)
- [ ] Task 3.3.3: 集成和测试 (1h)

---

### Epic 4: Workbench 系统 - 本地测试和评估

**目标**: 实现本地Prompt测试、比较、评分系统

**优先级**: 🟡 **高**
**预期工作量**: 2-3天
**价值**: 让用户快速验证prompt质量，无需多次API调用

---

#### Story 4.1: 测试用例生成器

```markdown
# Story: 实现测试用例生成器

## 描述
自动生成多样化的测试用例，覆盖边界值、等价类、领域特定场景。

## 验收标准
- [ ] 能生成10+多样化的测试用例
- [ ] 覆盖边界值测试
- [ ] 覆盖等价类测试
- [ ] 覆盖领域特定测试

## 实现策略
- 分析prompt的输入变量
- 对每个变量生成边界值、正常值、特殊值
- 组合形成测试用例
```

**任务分解**:
- [ ] Task 4.1.1: TestGenerator类 (2h)
- [ ] Task 4.1.2: 生成策略实现 (3h)
- [ ] Task 4.1.3: 测试 (1h)

---

#### Story 4.2: 变体比较器和质量评分器

```markdown
# Story: 实现变体比较器和质量评分器

## 变体比较器
并排比较多个prompt版本，在以下维度评分:
- 完整性 (25%)
- 准确性 (30%)
- 格式一致性 (15%)
- 响应时间 (10%)
- Token效率 (10%)
- 用户偏好 (10%)

## 质量评分器
5分制评分:
- 5分: 完全符合要求，可直接使用
- 4分: 基本符合，需微调
- 3分: 部分符合，需较多修改
- 2分: 大部分不符合
- 1分: 完全不符合

## 验收标准
- [ ] VariantComparator实现完成
- [ ] QualityGrader实现完成
- [ ] 评分结果准确可信
```

**任务分解**:
- [ ] Task 4.2.1: VariantComparator实现 (2h)
- [ ] Task 4.2.2: QualityGrader实现 (2h)
- [ ] Task 4.2.3: 评分算法优化 (1h)

---

#### Story 4.3: 版本管理器和代码导出器

```markdown
# Story: 实现版本管理器和代码导出器

## 版本管理器
记录prompt的每个版本:
- 版本号 (semantic versioning)
- 创建时间
- 变化说明
- 测试结果
- 评分

## 代码导出器
支持导出为:
- Python SDK代码
- TypeScript SDK代码
- cURL命令
- 其他格式

## 验收标准
- [ ] VersionManager实现完成
- [ ] 支持版本恢复
- [ ] ExportGenerator实现完成
- [ ] 导出代码可正确执行
```

**任务分解**:
- [ ] Task 4.3.1: VersionManager实现 (2h)
- [ ] Task 4.3.2: ExportGenerator实现 (2h)
- [ ] Task 4.3.3: 导出模板 (1h)

---

### Epic 5: CLI 集成和测试

**目标**: 集成所有新功能到CLI，完整测试和文档

**优先级**: 🔴 **关键**
**预期工作量**: 2天
**价值**: 用户界面，提供完整的体验

---

#### Story 5.1: CLI命令集成

```markdown
# Story: 实现新的CLI命令

## 新命令
1. pe generate - 从描述生成prompt
2. pe improve - 优化现有prompt
3. pe template - 模板管理
4. pe workbench - 工作台功能

## 验收标准
- [ ] 所有命令可执行
- [ ] 命令参数验证正常
- [ ] 帮助文档完整
- [ ] 错误消息清晰
```

**任务分解**:
- [ ] Task 5.1.1: generate.py实现 (1.5h)
- [ ] Task 5.1.2: improve.py实现 (1.5h)
- [ ] Task 5.1.3: template.py实现 (1h)
- [ ] Task 5.1.4: workbench.py实现 (1.5h)
- [ ] Task 5.1.5: pe_command.py修改支持路由 (1h)

---

#### Story 5.2: 完整测试和文档

```markdown
# Story: 完整测试和文档

## 测试
- [ ] 单元测试 (覆盖率 >80%)
- [ ] 集成测试
- [ ] E2E测试 (完整工作流)
- [ ] 向后兼容性测试

## 文档
- [ ] README更新
- [ ] API文档
- [ ] 使用指南
- [ ] CLI帮助文档

## 性能
- [ ] 基准测试
- [ ] 性能优化
```

**任务分解**:
- [ ] Task 5.2.1: 单元测试编写 (4h)
- [ ] Task 5.2.2: 集成和E2E测试 (3h)
- [ ] Task 5.2.3: 文档编写 (2h)
- [ ] Task 5.2.4: 性能测试和优化 (2h)

---

## 📊 故事优先级和依赖

```
┌─────────────────────────────────────────┐
│ Epic 1: Meta Prompt Engine (Day 1-2)    │
│ 优先级: 🔴 关键                          │
│ 依赖: 无                                 │
└────────────┬────────────────────────────┘
             │
             ├──────────────────────────────┐
             │                              │
    ┌────────▼──────────────┐      ┌───────▼──────────────┐
    │ Epic 2: Templates     │      │ Epic 3: Improver     │
    │ (Day 3-4)             │      │ (Day 4-6)            │
    │ 优先级: 🔴 关键        │      │ 优先级: 🟡 高        │
    │ 依赖: Epic 1 部分     │      │ 依赖: Epic 1 完成    │
    └───────┬────────────────┘      └──────┬──────────────┘
            │                               │
            └───────────────┬───────────────┘
                           │
                    ┌──────▼──────────┐
                    │ Epic 4: Workbench
                    │ (Day 7-9)
                    │ 优先级: 🟡 高
                    │ 依赖: Epic 1-3
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │ Epic 5: CLI     │
                    │ (Day 10-13)     │
                    │ 优先级: 🔴 关键 │
                    │ 依赖: 所有Epic  │
                    └─────────────────┘
```

---

## ✅ 工作流状态

### 当前状态: 📋 **规划完成，准备执行**

| Story | 状态 | 分配 | 开始 | 完成 |
|-------|------|------|------|------|
| 1.1 变量识别 | ⏳ 待开始 | - | - | - |
| 1.2 结构规划 | ⏳ 待开始 | - | - | - |
| 1.3 XML生成 | ⏳ 待开始 | - | - | - |
| 2.1 模板系统 | ⏳ 待开始 | - | - | - |
| 2.2-2.4 模板创建 | ⏳ 待开始 | - | - | - |
| 3.1-3.3 优化策略 | ⏳ 待开始 | - | - | - |
| 4.1-4.3 Workbench | ⏳ 待开始 | - | - | - |
| 5.1-5.2 CLI & 测试 | ⏳ 待开始 | - | - | - |

---

**文档结束**
*最后更新: 2025-12-24*
