# Prompt Enhancement v1.2.1 实现计划

> **目标**: 在v1.2基础上增强代码理解能力
> **周期**: 10个工作天
> **方法论**: TDD + 聚焦版增强

---

## 📊 **工作分解结构**

### 阶段1: 智能文件发现（Day 1-3）

**目标**：从模糊指令自动找到最相关的代码文件

#### Day 1: 关键词提取与文件匹配

**任务**:
```
1.1 实现 KeywordExtractor 类
    - 从用户指令中提取关键词
    - 识别技术关键词（函数名、类名、文件名）
    - 输出: List[keyword]

1.2 实现 FileMatcher 类
    - 文件名匹配（模糊匹配）
    - 路径匹配
    - 输出: List[filepath]
```

**验收标准**:
- [ ] 能从"添加认证"提取 ["认证", "auth", "authentication"]
- [ ] 能匹配到 auth.py, authentication.py, login_auth.py
- [ ] 支持模糊匹配（typo tolerance）

**时间估计**: 2-3小时

---

#### Day 2: 内容搜索与依赖追踪

**任务**:
```
2.1 实现 ContentSearcher 类
    - grep相关函数/类名
    - 找到定义和使用位置
    - 输出: Dict[filepath -> List[symbol]]

2.2 实现 DependencyTracer 类
    - 追踪import关系
    - 找到关联的模块
    - 输出: List[related_file]
```

**验收标准**:
- [ ] 搜索关键词能找到函数定义
- [ ] 能追踪import链（A imports B, B imports C）
- [ ] 性能: 搜索<3秒

**时间估计**: 2-3小时

---

#### Day 3: 相关性排序与集成

**任务**:
```
3.1 实现 RelevanceRanker 类
    - 综合匹配度评分
    - 按相关性排序
    - 返回Top 5-10文件

3.2 集成到 ContextCollector
    - 添加 find_relevant_files() 方法
    - 输出最相关文件列表
```

**验收标准**:
- [ ] 返回文件数量: 5-10
- [ ] Top 1文件准确率 >90%
- [ ] 完整流程<5秒

**时间估计**: 2小时

---

### 阶段2: 符号索引（Day 4-5）

**目标**：快速提取函数/类签名，减少token浪费

#### Day 4: 符号提取

**任务**:
```
4.1 实现 PythonSymbolExtractor 类
    - 提取函数签名: def func(args) -> type
    - 提取类定义: class Name(Base): + 方法列表
    - 提取属性: 字段名和类型

4.2 实现 JavaScriptSymbolExtractor 类
    - 支持 function declarations
    - 支持 class definitions
    - 支持 arrow functions
```

**验收标准**:
- [ ] Python: 能正确提取100+行类的所有方法
- [ ] JavaScript: 能提取class和function签名
- [ ] 输出格式标准化

**时间估计**: 3-4小时

---

#### Day 5: 缓存与集成

**任务**:
```
5.1 实现 SymbolCache 类
    - 文件修改时更新缓存
    - 支持增量更新
    - 性能: 缓存命中<100ms

5.2 集成到 ContextCollector
    - get_file_symbols() 方法
    - 用符号索引替换完整文件内容
```

**验收标准**:
- [ ] 缓存命中率 >95%
- [ ] Token节省 >50%
- [ ] 增量更新<1秒

**时间估计**: 2-3小时

---

### 阶段3: 编码模板精简（Day 6-7）

**目标**：创建5个核心编码模板，使用XML最佳实践格式

#### Day 6: 实现类型和基础模板

**任务**:
```
6.1 创建模板系统
    - TemplateBase 基类
    - 支持触发词识别
    - 支持条件模板选择

6.2 创建5个核心模板
    - implement.yaml: 新功能
    - fix.yaml: 修复bug
    - refactor.yaml: 重构
    - test.yaml: 测试
    - review.yaml: 审查
```

**模板格式示例**:
```yaml
name: "实现新功能"
triggers: ["添加", "实现", "创建", "开发"]
task_type: "coding"

checklist:
  - "理解需求和边界条件"
  - "设计接口和数据结构"
  - "实现核心逻辑"
  - "添加错误处理"
  - "编写单元测试"
  - "更新文档"

best_practices:
  python:
    - "使用type hints"
    - "添加docstring"
    - "遵循PEP8"
    - "至少覆盖80%测试"
  javascript:
    - "定义接口类型 (TypeScript)"
    - "处理Promise rejection"
    - "添加JSDoc注释"
```

**验收标准**:
- [ ] 5个模板全部创建
- [ ] 每个模板有3个触发词
- [ ] 所有技术栈都有最佳实践

**时间估计**: 3-4小时

---

#### Day 7: 测试和优化

**任务**:
```
7.1 编写模板测试
    - 触发词识别测试
    - 模板加载测试
    - 内容格式验证

7.2 性能优化
    - 模板缓存
    - 延迟加载
```

**验收标准**:
- [ ] 100%覆盖率
- [ ] 模板加载<100ms
- [ ] 所有测试通过

**时间估计**: 2-3小时

---

### 阶段4: AGENTS.md自动生成（Day 8-9）

**目标**：为没有AGENTS.md的项目自动生成初稿

#### Day 8: 项目分析和AGENTS.md生成

**任务**:
```
8.1 实现 ProjectAnalyzer 类
    - 检测项目类型（Python/Node/ROS2等）
    - 分析技术栈
    - 提取命令

8.2 实现 AgentsGenerator 类
    - 生成技术栈部分
    - 生成命令部分
    - 生成代码风格部分
```

**生成内容**:
```markdown
# AGENTS.md (自动生成)

## 技术栈
- Python 3.11
- Flask 2.3
- SQLAlchemy 2.0

## 命令
- setup: `pip install -r requirements.txt`
- dev: `flask run --debug`
- test: `pytest tests/ -v`

## 代码风格 (推断自现有代码)
- 使用type hints
- snake_case命名
- 每个函数需要docstring

## 边界约束
<!-- TODO: 补充不应修改的文件/目录 -->
```

**验收标准**:
- [ ] 能检测3+种项目类型
- [ ] 命令提取准确率 >80%
- [ ] 生成的AGENTS.md有效

**时间估计**: 3-4小时

---

#### Day 9: CLI集成和交互

**任务**:
```
9.1 创建 pe --init-agents 命令
    - 检查是否存在AGENTS.md
    - 自动生成或更新
    - 交互提示用户补充

9.2 集成到CLI
    - 添加命令行选项
    - 添加帮助文本
```

**验收标准**:
- [ ] 命令正常执行
- [ ] 生成的文件有效
- [ ] 用户可以编辑补充

**时间估计**: 2-3小时

---

### 阶段5: 性能优化 + 测试 + 发布（Day 10）

#### Day 10: 性能优化 & 全量测试 & 发布

**任务**:
```
10.1 性能优化
     - 并行化文件扫描
     - 优化符号索引
     - 实现智能缓存
     - 目标: 冷启动<15s, 缓存<5s

10.2 全量测试
     - 运行所有单元测试
     - 覆盖率检查 >80%
     - v1.2回归测试 100%

10.3 发布
     - 更新版本号
     - 更新CHANGELOG
     - 创建git tag
     - 发布release
```

**验收标准**:
- [ ] 冷启动响应时间 <15s
- [ ] 缓存命中时间 <5s
- [ ] 新代码覆盖率 >80%
- [ ] v1.2所有测试通过
- [ ] v1.2.1-release tag created

**时间估计**: 4小时

---

## 📦 **文件清单**

### 新增文件

```
src/prompt_enhancement/
├── file_discoverer.py       # 智能文件发现
├── symbol_indexer.py        # 符号索引
├── agents_generator.py      # AGENTS.md生成器
├── templates/
│   ├── implement.yaml       # 新功能模板
│   ├── fix.yaml             # 修复模板
│   ├── refactor.yaml        # 重构模板
│   ├── test.yaml            # 测试模板
│   └── review.yaml          # 审查模板
└── ...

tests/
├── test_file_discoverer.py
├── test_symbol_indexer.py
├── test_agents_generator.py
└── test_templates.py
```

### 修改文件

```
src/prompt_enhancement/
├── context_collector.py     # 集成新模块
└── enhanced_prompt_generator.py
```

---

## ⏰ **里程碑**

| 里程碑 | 时间 | 完成标准 |
|--------|------|---------|
| M1 | Day 3 | 智能文件发现可用 |
| M2 | Day 5 | 符号索引可用 |
| M3 | Day 7 | 5个编码模板完成 |
| M4 | Day 9 | AGENTS.md生成可用 |
| M5 | Day 10 | v1.2.1发布 |

---

## ✅ **发布检查清单**

- [ ] 所有阶段完成
- [ ] 新代码覆盖率 >80%
- [ ] v1.2回归测试 100%通过
- [ ] 文档更新完整
- [ ] 版本号更新为1.2.1
- [ ] CHANGELOG更新
- [ ] GitHub Release创建
- [ ] 最终测试通过

---

**计划完成**
*由BMAD Master执行*
*2025-12-24*

