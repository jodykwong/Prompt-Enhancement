# Prompt Enhancement v1.2.1 产品需求文档

> **版本**: 1.2.1
> **日期**: 2025-12-24
> **状态**: 规划中
> **方向**: 聚焦代码项目的增强版本

---

## 🎯 **核心定位**

**Prompt Enhancement v1.2.1** 是一个**代码项目专用的CLI增强工具**，不是通用prompt生成系统。

**定位声明**：
> 输入：用户在代码仓库中的模糊指令
> 输出：注入了项目上下文和编码最佳实践的增强 prompt

---

## 📊 **用户需求**

### 问题1：手动找相关代码太慢
**现象**：
```bash
$ pe "添加用户认证"
# 需要用户手动告诉系统哪些文件相关
```

**解决方案 - 智能文件发现**：
```bash
$ pe "添加用户认证"
# 自动找到：
# - src/models/user.py (用户模型)
# - src/routes/auth.py (认证路由)
# - src/config/security.py (安全配置)
```

---

### 问题2：缺少函数级别的上下文
**现象**：
```
上下文只有完整的文件内容，导致token浪费
```

**解决方案 - 符号索引**：
```python
# 自动提取符号签名（不是整个文件）
class User(db.Model):
    - id: int
    - email: str
    - password_hash: str
    - created_at: datetime

    def set_password(password: str) -> None
    def check_password(password: str) -> bool
```

---

### 问题3：新项目没有AGENTS.md
**现象**：
```
新项目没有边界约束说明，Claude可能违反项目规则
```

**解决方案 - AGENTS.md自动生成**：
```bash
$ pe --init-agents
# 自动生成：
# - 技术栈检测
# - 命令提取
# - 代码风格推断
# - 边界约束模板
```

---

### 问题4：响应时间太长
**现象**：
```
冷启动30秒，缓存10秒 → 太慢
```

**解决方案 - 性能优化**：
```
冷启动: 30s → 15s
缓存命中: 10s → 5s
```

---

## ✨ **核心能力**

### 1. Context Collector（增强版）
**现有能力**：
- ✅ 技术栈检测
- ✅ 项目结构分析
- ✅ Git历史收集

**新增能力**：
- 🆕 智能文件发现：从模糊指令找到最相关5-10个文件
- 🆕 符号索引：提取函数/类签名（不是完整代码）

---

### 2. Coding Templates（精简版）
**4个核心模板**：

| 模板 | 触发词 | 用途 |
|------|--------|------|
| `implement.yaml` | 添加/实现/创建 | 新功能实现 |
| `fix.yaml` | 修复/bug/错误 | Bug修复 |
| `refactor.yaml` | 重构/优化/改进 | 代码重构 |
| `test.yaml` | 测试/覆盖率 | 测试编写 |
| `review.yaml` | 审查/检查 | 代码审查 |

**模板格式** (使用XML最佳实践)：
```yaml
name: "实现新功能"
triggers: ["添加", "实现", "创建"]

checklist:
  - "理解需求和边界"
  - "设计接口和数据结构"
  - "实现核心逻辑"
  - "添加错误处理"
  - "编写单元测试"

best_practices:
  python:
    - "使用type hints"
    - "添加docstring"
    - "遵循PEP8"
  javascript:
    - "定义接口类型"
    - "处理异常"
```

---

### 3. AGENTS.md 自动生成
**生成内容**：
```markdown
# AGENTS.md (自动生成)

## 技术栈
- Python 3.11
- Flask 2.3
- SQLAlchemy 2.0

## 命令
- 安装: `pip install -r requirements.txt`
- 开发: `flask run --debug`
- 测试: `pytest tests/ -v`

## 代码风格 (推断)
- 使用type hints
- snake_case命名
- 每个函数需要docstring

## 边界约束
<!-- TODO: 补充不应修改的文件 -->
```

---

## 🎬 **成功指标**

| 指标 | 当前 | 目标 | 优先级 |
|------|------|------|--------|
| 冷启动响应时间 | 30s | <15s | ⭐⭐⭐ |
| 缓存命中时间 | 10s | <5s | ⭐⭐⭐ |
| 智能文件发现准确率 | N/A | >80% | ⭐⭐ |
| AGENTS.md生成可用性 | N/A | 100% | ⭐⭐ |
| 代码覆盖率 | >80% | 100% | ⭐ |

---

## 📋 **发布标准**

v1.2.1发布需要满足：

1. ✅ 智能文件发现可用
2. ✅ 符号索引可用
3. ✅ 5个编码模板完成
4. ✅ AGENTS.md自动生成可用
5. ✅ 性能优化完成
6. ✅ 所有新代码测试覆盖 >80%
7. ✅ 所有v1.2测试100%通过（向后兼容）
8. ✅ 文档更新完整

---

## ⏰ **时间表**

- **Day 1-3**: 智能文件发现
- **Day 4-5**: 符号索引
- **Day 6-7**: 编码模板精简
- **Day 8-9**: AGENTS.md自动生成
- **Day 10**: 性能优化 + 测试 + 发布

**总计**: 10个工作天

---

**文档完成**
*由BMAD Master执行*

